# Rope æ€§èƒ½æ¶æ„åˆ†æ

## 1. å½“å‰ Zero-Allocs æ“ä½œ âœ…

### å®Œå…¨æ— åˆ†é…çš„æ“ä½œï¼š
- **Length()**: 0.67 ns - ç›´æ¥è®¿é—®ç»“æ„ä½“å­—æ®µ
- **Slice_Middle()**: 58,776 ns - å­—ç¬¦ä¸²åˆ‡ç‰‡ (é›¶æ‹·è´)
- **ByteCache()**: 354 ns - ç¼“å­˜å¤ç”¨
- **ChunkCount()**: 6.79 ns - èŠ‚ç‚¹è®¡æ•°

### ä¸ºä»€ä¹ˆèƒ½å®ç° Zero-Allocsï¼Ÿ
1. **Length/ChunkCount**: åªè¯»å±æ€§ï¼Œæ— éœ€è®¡ç®—
2. **Slice**: Go å­—ç¬¦ä¸²åˆ‡ç‰‡æ˜¯é›¶æ‹·è´æ“ä½œ
3. **ByteCache**: é¢„åˆ†é…ç¼“å­˜ + é€»è¾‘å¤ç”¨

---

## 2. æ— æ³•å®ç° Zero-Allocs çš„æ“ä½œ âš ï¸

### A. ä¿®æ”¹æ“ä½œ

| æ“ä½œ | å½“å‰åˆ†é… | åŸå›  | æ˜¯å¦å¯ä¼˜åŒ– |
|------|---------|------|-----------|
| Insert | 4-5 allocs | ä¸å¯å˜æ¶æ„éœ€è¦åˆ›å»ºæ–°èŠ‚ç‚¹ | âŒ ä¸å¯è¡Œ |
| Delete | 3 allocs | ä¸å¯å˜æ¶æ„éœ€è¦åˆ›å»ºæ–°èŠ‚ç‚¹ | âŒ ä¸å¯è¡Œ |
| Replace | 8 allocs | Delete + Insert | âŒ ä¸å¯è¡Œ |

**ä¸ºä»€ä¹ˆæ— æ³•ä¼˜åŒ–ï¼Ÿ**
Rope é‡‡ç”¨**ä¸å¯å˜æ•°æ®ç»“æ„**ï¼š
- ä¿®æ”¹æ“ä½œå¿…é¡»åˆ›å»ºæ–°çš„æ ‘èŠ‚ç‚¹
- è·¯å¾„ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦é‡å»º
- è¿™æ˜¯æŒä¹…åŒ–æ•°æ®ç»“æ„çš„å›ºæœ‰ç‰¹æ€§

### B. è½¬æ¢æ“ä½œ

| æ“ä½œ | å½“å‰åˆ†é… | åŸå›  | æ˜¯å¦å¯ä¼˜åŒ– |
|------|---------|------|-----------|
| String() | 3 allocs | strings.Builder + éå† | âš ï¸ éƒ¨åˆ†å¯ä¼˜åŒ– |
| Bytes() | 3+ allocs | String() + []byte() | âš ï¸ å¯ä¼˜åŒ– |

---

## 3. å¯ä»¥ä¼˜åŒ–åˆ° Zero/Near-Zero Allocs çš„æ“ä½œ ğŸ¯

### A. Bytes() - å¯ä»¥ä¼˜åŒ–ï¼

**å½“å‰å®ç°**ï¼š
```go
func (r *Rope) Bytes() []byte {
    return []byte(r.String())  // ä¸¤æ¬¡åˆ†é…ï¼
}
```

**ä¼˜åŒ–æ–¹æ¡ˆ 1**: ç›´æ¥æ„å»º []byteï¼ˆå‡å°‘åˆ° 1 allocï¼‰
```go
func (r *Rope) Bytes() []byte {
    if r.length == 0 {
        return []byte{}
    }
    
    // é¢„åˆ†é…ç²¾ç¡®å¤§å°
    bytes := make([]byte, r.size)
    offset := 0
    
    // éå† chunks ç›´æ¥å¤åˆ¶
    it := r.Chunks()
    for it.Next() {
        chunk := it.Current()
        n := copy(bytes[offset:], chunk)
        offset += n
    }
    
    return bytes
}
```

**ä¼˜åŒ–æ–¹æ¡ˆ 2**: ä½¿ç”¨ sync.Pool å®ç°çœŸæ­£çš„ zero allocs
```go
var bytesPool = sync.Pool{
    New: func() interface{} {
        return make([]byte, 4096)
    },
}

func (r *Rope) Bytes() []byte {
    buf := bytesPool.Get().([]byte)
    if len(buf) < r.size {
        buf = make([]byte, r.size)
    }
    
    // ... å¡«å……æ•°æ® ...
    
    result := make([]byte, r.size)
    copy(result, buf[:r.size])
    bytesPool.Put(buf)
    
    return result
}
```

### B. CharAt() - å·²ç»ä¼˜åŒ–è‰¯å¥½

**å½“å‰**: 1 alloc (è¿­ä»£å™¨)  
**ç†è®ºä¸Š**: ä½¿ç”¨ç¼“å­˜å¯ä»¥å®ç° 0 allocs  
**æƒè¡¡**: ç¼“å­˜ä¼šå¢åŠ å†…å­˜å ç”¨å’Œå¤æ‚åº¦

### C. LineAtChar() - å¯ä»¥ä¼˜åŒ–

**å½“å‰**: 1 alloc (è¿­ä»£å™¨)  
**æ–¹æ¡ˆ**: æ·»åŠ è¡Œå·ç¼“å­˜
```go
type Rope struct {
    // ... ç°æœ‰å­—æ®µ ...
    lineCache     map[int]int  // char pos -> line number
    lineCacheDirty bool
}
```
**æƒè¡¡**: å¢åŠ å†…å­˜ï¼Œå¯¹åªè¯» rope æœ‰æ•ˆ

---

## 4. æ¶æ„æƒè¡¡åˆ†æ

### ä¸å¯å˜ vs å¯å˜

| ç‰¹æ€§ | ä¸å¯å˜ Rope | å¯å˜ Rope |
|------|-------------|-----------|
| çº¿ç¨‹å®‰å…¨ | âœ… å¤©ç„¶å®‰å…¨ | âŒ éœ€è¦é” |
| COW | âœ… å…è´¹æ‹·è´ | âŒ éœ€è¦æ˜¾å¼æ‹·è´ |
| æ’¤é”€/é‡åš | âœ… å¤©ç„¶æ”¯æŒ | âŒ éœ€è¦æ‰‹åŠ¨å®ç° |
| å†…å­˜åˆ†é… | âš ï¸ è¾ƒå¤š | âœ… è¾ƒå°‘ |
| æ€§èƒ½ | âš ï¸ ä¿®æ”¹æ…¢ | âœ… ä¿®æ”¹å¿« |

**ç»“è®º**: ä¸å¯å˜æ¶æ„çš„åˆ†é…å¼€é”€æ˜¯**æœ‰æ„ä¸ºä¹‹çš„ç‰¹æ€§**ï¼Œä¸æ˜¯ç¼ºé™·ã€‚

---

## 5. å®é™…åº”ç”¨å»ºè®®

### å¯¹äºéœ€è¦ Zero-Allocs çš„åœºæ™¯ï¼š

1. **æ‰¹é‡æ“ä½œ**: ä½¿ç”¨ RopeBuilderï¼ˆæ‰¹é‡åå†æ„å»ºï¼‰
2. **åªè¯»æŸ¥è¯¢**: ç¼“å­˜å¸¸ç”¨æŸ¥è¯¢ç»“æœ
3. **é¢‘ç¹è½¬æ¢**: ä½¿ç”¨ Bytes() è€Œé String()

### å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–çš„æ–¹å‘ï¼š

1. **Bytes() æ–¹æ³•**: å®ç°ç›´æ¥æ„å»ºç‰ˆæœ¬ï¼ˆ1 alloc â†’ å¯èƒ½ä¸º 0ï¼‰
2. **å¯¹è±¡æ± åŒ–**: å¯¹è¿­ä»£å™¨ä½¿ç”¨ sync.Pool
3. **ç¼“å­˜ç­–ç•¥**: ä¸ºå¸¸ç”¨æŸ¥è¯¢æ·»åŠ  LRU ç¼“å­˜
4. **å»¶è¿Ÿæ±‚å€¼**: String() å¯ä»¥å»¶è¿Ÿåˆ°çœŸæ­£éœ€è¦æ—¶

---

## 6. æ€§èƒ½ä¼˜åŒ–æ€»ç»“

### å·²ä¼˜åŒ– âœ…
- 7 æ¬¡æäº¤ï¼Œæ‰€æœ‰çƒ­ç‚¹æ“ä½œä¼˜åŒ–å®Œæˆ
- æ¶ˆé™¤äº†æ‰€æœ‰ []rune è½¬æ¢
- Slice å®ç° zero allocs
- Iterator/ForEach ä» 661ms â†’ 0.13ms (5,000x+)

### æ¶æ„å›ºæœ‰é™åˆ¶ âš ï¸
- ä¸å¯å˜æ€§å¯¼è‡´ä¿®æ”¹æ“ä½œå¿…ç„¶åˆ†é…å†…å­˜
- è¿™æ˜¯è®¾è®¡æƒè¡¡ï¼Œä¸æ˜¯æ€§èƒ½ bug

### æœªæ¥ä¼˜åŒ–æ–¹å‘ ğŸš€
- Bytes() ç›´æ¥æ„å»ºï¼ˆå¯ä»¥åšåˆ° 1 allocï¼‰
- è€ƒè™‘å¯¹è±¡æ± åŒ–ï¼ˆå¯èƒ½åšåˆ° 0 allocsï¼‰
- æ·»åŠ æŸ¥è¯¢ç¼“å­˜ï¼ˆè¯»å¤šå†™å°‘åœºæ™¯ï¼‰

---

## 7. æœ€ç»ˆå»ºè®®

**å½“å‰çš„å®ç°å·²ç»éå¸¸ä¼˜ç§€**ï¼š
- âœ… çƒ­ç‚¹è·¯å¾„å…¨éƒ¨ä¼˜åŒ–
- âœ… åˆ†é…æ•°é‡æä½ï¼ˆ3-8 allocsï¼‰
- âœ… æ€§èƒ½å·²è¾¾ç”Ÿäº§çº§

**Zero-allocs ä¸æ˜¯å”¯ä¸€ç›®æ ‡**ï¼š
- ä¸å¯å˜æ¶æ„çš„ä»·å€¼ > å°‘é‡åˆ†é…
- çº¿ç¨‹å®‰å…¨ã€COWã€æŒä¹…åŒ–æ›´é‡è¦
- å½“å‰åˆ†é…å·²ç»éå¸¸é«˜æ•ˆï¼ˆKB çº§åˆ«ï¼Œé MB/GBï¼‰

**ä¸å»ºè®®ç›²ç›®è¿½æ±‚ zero allocs**ï¼š
- ä¼šå¢åŠ ä»£ç å¤æ‚åº¦
- å¯èƒ½å¼•å…¥ bug
- æ”¶ç›Šé€’å‡ï¼ˆ3 allocs â†’ 0 allocs æ”¶ç›Šæœ‰é™ï¼‰
